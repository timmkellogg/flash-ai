<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>N4 Japanese Grammar Flashcards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --good: #34d399;
      --bad: #f87171;
    }
    * { box-sizing: border-box }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 70% -10%, #1f2937 0%, var(--bg) 40%);
      color: var(--text)
    }
    .wrap {
      min-height: 100dvh;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 16px;
      padding: 18px
    }
    header, footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap
    }
    header h1 {
      font-size: 18px;
      margin: 0
    }
    header .controls, footer .stats {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }
    button, select, input[type="search"] {
      background: #0b1220;
      color: var(--text);
      border: 1px solid #27334a;
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 14px
    }
    button:focus-visible, select:focus-visible, input:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px
    }
    button.primary { border-color: #1b2a43 }
    .pill { font-size: 12px; color: var(--muted) }
    .deck {
      max-width: 920px;
      margin: 0 auto;
      width: 100%
    }
    .card {
      background: linear-gradient(180deg, #0d1424, var(--card));
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
      cursor: pointer;
      user-select: none
    }
    .front h2, .back h2 {
      margin: 0 0 6px 0;
      font-size: 28px
    }
    .front .subtitle, .back .subtitle {
      color: var(--muted);
      margin-bottom: 18px
    }
    .tags { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0 0 }
    .tag {
      font-size: 12px;
      color: #67e8f9;
      background: rgba(34,211,238,.08);
      border: 1px solid rgba(34,211,238,.2);
      padding: 2px 8px;
      border-radius: 999px
    }
    .examples { margin-top: 12px; display: grid; gap: 10px }
    .ex { background: #0b1220; border: 1px solid #1b2540; border-radius: 10px; padding: 10px }
    .ex .jp { font-weight: 600 }
    .ex .romaji { color: #a1a1aa; font-size: 13px }
    .ex .en { color: #cbd5e1; margin-top: 4px }
    .actions {
      display: grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
      margin-top: 14px
    }
    .actions button { padding: 10px 12px }
    .good { border-color: rgba(52,211,153,.4) }
    .bad { border-color: rgba(248,113,113,.35) }
    .hidden { display: none }
    footer {
      opacity: .9
    }
    .hotkeys { color: var(--muted); font-size: 12px }
    .progress {
      height: 6px;
      background: #0b1220;
      border: 1px solid #1b2540;
      border-radius: 999px;
      overflow: hidden
    }
    .progress > div {
      height: 100%;
      background: linear-gradient(90deg, #22d3ee, #34d399)
    }
    @media (max-width: 640px) {
      .actions { grid-template-columns: repeat(2, minmax(0,1fr)) }
      .front h2, .back h2 { font-size: 22px }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>N4 Grammar Flashcards <span class="pill">click card to flip • <span class="hotkeys">[Space]=Flip, [A]=Again, [G]=Got it, [←]/[→]=Prev/Next</span></span></h1>
      <div class="controls">
        <input id="search" type="search" placeholder="Search grammar / English / example…" />
        <select id="tagFilter">
          <option value="">All tags</option>
        </select>
        <select id="sort">
          <option value="shuffle">Shuffle</option>
          <option value="mistakes">Sort by most missed</option>
          <option value="alpha">Alphabetical (JP)</option>
        </select>
        <button id="reset" title="Forget progress">Reset Progress</button>
      </div>
    </header>

    <main class="deck">
      <div id="card" class="card" tabindex="0" aria-live="polite" aria-label="Flashcard. Click to flip.">
        <div class="front" id="front"></div>
        <div class="back hidden" id="back"></div>
      </div>
      <div class="actions">
        <button id="prev" class="primary" title="←">◀ Prev</button>
        <button id="flip" class="primary" title="Space">Flip</button>
        <button id="again" class="bad" title="A">Again</button>
        <button id="got" class="good" title="G">Got it</button>
      </div>
      <div class="stats" style="margin-top:10px; display:flex; align-items:center; gap:12px; flex-wrap:wrap">
        <div class="progress" style="flex:1; min-width:160px"><div id="bar" style="width:0%"></div></div>
        <div id="count" class="pill">0 / 0</div>
        <div id="score" class="pill">✅ 0 • ❌ 0</div>
      </div>
    </main>

    <footer>
      <div class="pill">Tip: filter by tag (e.g., “cause”, “ability”, “obligation”) to focus your study</div>
      <div class="pill">Data saved locally only</div>
    </footer>
  </div>

  <script>
    // ---- Deck data (add/edit freely). Keep id stable for saved stats. No semicolons by user preference.
    const DECK = [
      {
        id: 'node-1',
        jp: '〜ので',
        structure: 'Plain form + ので',
        meaning: 'because, since (objective reason)',
        tags: ['cause'],
        notes: 'Often softer/more objective than から',
        examples: [
          { jp: '雨なので、出かけません', romaji: 'ame na no de, dekakemasen', en: "Because it's raining, I won't go out" },
          { jp: '忙しいので、後で電話します', romaji: 'isogashii no de, ato de denwa shimasu', en: "Since I'm busy, I'll call later" }
        ]
      },
      {
        id: 'sugiru-2',
        jp: '〜すぎる',
        structure: 'Verb stem / い-adj (remove い) / な-adj + すぎる',
        meaning: 'too much, excessively',
        tags: ['degree'],
        examples: [
          { jp: '食べすぎた', romaji: 'tabesugita', en: 'I ate too much' },
          { jp: '静かすぎる町', romaji: 'shizuka sugiru machi', en: 'A town that is too quiet' }
        ]
      },
      {
        id: 'ta-koto-aru-3',
        jp: '〜たことがある',
        structure: 'V-た + ことがある',
        meaning: 'have done (experience)',
        tags: ['experience'],
        examples: [
          { jp: '寿司を作ったことがあります', romaji: 'sushi o tsukutta koto ga arimasu', en: 'I have made sushi before' }
        ]
      },
      {
        id: 'to-4',
        jp: '〜と',
        structure: 'Plain + と',
        meaning: 'when/whenever (natural result), if',
        tags: ['condition'],
        notes: 'General truths / automatic results',
        examples: [
          { jp: '春になると、桜が咲く', romaji: 'haru ni naru to, sakura ga saku', en: 'When it becomes spring, cherry blossoms bloom' }
        ]
      },
      {
        id: 'naide-5',
        jp: '〜ないで',
        structure: 'V-ないで',
        meaning: 'without doing',
        tags: ['negation', 'manner'],
        examples: [
          { jp: '朝ごはんを食べないで出かけた', romaji: 'asagohan o tabenaide dekaketa', en: 'I went out without eating breakfast' }
        ]
      },
      {
        id: 'you-ni-naru-6',
        jp: '〜ようになる',
        structure: 'V-辞書形/ない形 + ようになる',
        meaning: 'to become able to / reach a state',
        tags: ['change', 'ability'],
        examples: [
          { jp: '日本語が話せるようになった', romaji: 'nihongo ga hanaseru you ni natta', en: 'I became able to speak Japanese' }
        ]
      },
      {
        id: 'te-miru-7',
        jp: '〜てみる',
        structure: 'V-て + みる',
        meaning: 'try doing',
        tags: ['attempt'],
        examples: [
          { jp: '新しい料理を作ってみる', romaji: 'atarashii ryouri o tsukutte miru', en: 'I will try making a new dish' }
        ]
      },
      {
        id: 'kamo-8',
        jp: '〜かもしれない',
        structure: 'Plain + かもしれない',
        meaning: 'might, maybe',
        tags: ['probability'],
        examples: [
          { jp: '明日は雨かもしれない', romaji: 'ashita wa ame kamoshirenai', en: 'It might rain tomorrow' }
        ]
      },
      {
        id: 'te-oku-9',
        jp: '〜ておく',
        structure: 'V-て + おく',
        meaning: 'do in advance / leave as is',
        tags: ['preparation'],
        examples: [
          { jp: '会議室を予約しておく', romaji: 'kaigishitsu o yoyaku shite oku', en: 'Reserve the meeting room in advance' }
        ]
      },
      {
        id: 'te-shimau-10',
        jp: '〜てしまう',
        structure: 'V-て + しまう',
        meaning: 'finish completely / unfortunately',
        tags: ['completion', 'regret'],
        examples: [
          { jp: '電車を逃してしまった', romaji: 'densha o nogashite shimatta', en: 'I ended up missing the train' }
        ]
      },
      {
        id: 'nakereba-11',
        jp: '〜なければならない',
        structure: 'V-ない + なければならない',
        meaning: 'must, have to',
        tags: ['obligation'],
        examples: [
          { jp: '早く寝なければならない', romaji: 'hayaku nenakereba naranai', en: 'I have to sleep early' }
        ]
      },
      {
        id: 'yasui-nikui-12',
        jp: '〜やすい / 〜にくい',
        structure: 'Verb stem + やすい / にくい',
        meaning: 'easy to do / hard to do',
        tags: ['tendency'],
        examples: [
          { jp: '読みやすい本', romaji: 'yomiyasui hon', en: 'An easy-to-read book' },
          { jp: '起きにくい朝', romaji: 'okinikui asa', en: 'A morning that is hard to get up' }
        ]
      },
      {
        id: 'aida-ni-13',
        jp: '〜間に',
        structure: 'Nの / V-ている / い/な + 間に',
        meaning: 'while / during (momentary action within)',
        tags: ['time'],
        examples: [
          { jp: '留守の間に泥棒が入った', romaji: 'rusu no aida ni dorobou ga haitta', en: 'A thief broke in while I was away' }
        ]
      },
      {
        id: 'tochuu-14',
        jp: '〜途中で',
        structure: 'Nの / V-辞書形 + 途中で',
        meaning: 'in the middle of / on the way',
        tags: ['time'],
        examples: [
          { jp: '学校へ行く途中で雨が降った', romaji: 'gakkou e iku tochuu de ame ga futta', en: 'It rained on the way to school' }
        ]
      },
      {
        id: 'you-ni-suru-15',
        jp: '〜ようにする',
        structure: 'V-辞書形/ない形 + ようにする',
        meaning: 'make an effort to / try to make a habit',
        tags: ['habit'],
        examples: [
          { jp: '毎日日本語を勉強するようにしている', romaji: 'mainichi nihongo o benkyou suru you ni shite iru', en: "I'm trying to study Japanese every day" }
        ]
      },
      {
        id: 'ba-16',
        jp: '〜ば',
        structure: 'V-仮定形 + ば / い→ければ / な→なら',
        meaning: 'if (hypothetical, formal)',
        tags: ['condition'],
        examples: [
          { jp: '時間があれば行きます', romaji: 'jikan ga areba ikimasu', en: "If I have time, I'll go" }
        ]
      },
      {
        id: 'nara-17',
        jp: '〜なら',
        structure: 'N / い/な / V + なら',
        meaning: 'if / as for (topic-based condition)',
        tags: ['condition', 'topic'],
        examples: [
          { jp: '東京なら電車が便利です', romaji: 'toukyou nara densha ga benri desu', en: 'If it’s Tokyo, trains are convenient' }
        ]
      },
      {
        id: 'noni-18',
        jp: '〜のに',
        structure: 'Plain + のに',
        meaning: 'although / despite',
        tags: ['contrast'],
        examples: [
          { jp: '安いのにおいしい', romaji: 'yasui noni oishii', en: "It's cheap, yet tasty" }
        ]
      },
      {
        id: 'nagara-19',
        jp: '〜ながら',
        structure: 'Verb stem + ながら',
        meaning: 'while doing (simultaneous actions)',
        tags: ['manner', 'time'],
        examples: [
          { jp: '音楽を聞きながら勉強する', romaji: 'ongaku o kikinagara benkyou suru', en: 'Study while listening to music' }
        ]
      }
    ]

    // ---- Minimal spaced practice: track right/wrong counts per id
    const STORAGE_KEY = 'n4_flash_stats_v1'
    const state = {
      order: [],
      i: 0,
      flipped: false,
      stats: loadStats(),
      correct: 0,
      wrong: 0,
      filtered: []
    }

    function loadStats () {
      try {
        const raw = localStorage.getItem(STORAGE_KEY)
        return raw ? JSON.parse(raw) : {}
      } catch {
        return {}
      }
    }

    function saveStats () {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.stats))
    }

    function ensureAllStats () {
      for (const card of DECK) {
        if (!state.stats[card.id]) state.stats[card.id] = { right: 0, wrong: 0 }
      }
    }

    // ---- UI hooks
    const elFront = document.getElementById('front')
    const elBack = document.getElementById('back')
    const elCard = document.getElementById('card')
    const elPrev = document.getElementById('prev')
    const elFlip = document.getElementById('flip')
    const elAgain = document.getElementById('again')
    const elGot = document.getElementById('got')
    const elBar = document.getElementById('bar')
    const elCount = document.getElementById('count')
    const elScore = document.getElementById('score')
    const elSort = document.getElementById('sort')
    const elTagFilter = document.getElementById('tagFilter')
    const elSearch = document.getElementById('search')
    const elReset = document.getElementById('reset')

    // ---- Init
    ensureAllStats()
    populateTagFilter()
    applyFilterAndSort()
    render()

    // ---- Helpers
    function shuffle (arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1))
        const t = arr[i]
        arr[i] = arr[j]
        arr[j] = t
      }
      return arr
    }

    function currentDeck () {
      return state.filtered.length ? state.filtered : DECK
    }

    function applyFilterAndSort () {
      const term = elSearch.value.trim().toLowerCase()
      const tag = elTagFilter.value
      let list = DECK.filter(c => {
        const hay = [
          c.jp, c.meaning, c.structure,
          ...(c.tags || []),
          ...(c.examples || []).flatMap(e => [e.jp, e.romaji, e.en])
        ].join(' ').toLowerCase()
        const okTerm = term ? hay.includes(term) : true
        const okTag = tag ? (c.tags || []).includes(tag) : true
        return okTerm && okTag
      })

      const sort = elSort.value
      if (sort === 'alpha') {
        list = [...list].sort((a, b) => a.jp.localeCompare(b.jp, 'ja'))
      } else if (sort === 'mistakes') {
        list = [...list].sort((a, b) => {
          const A = state.stats[a.id] || { right: 0, wrong: 0 }
          const B = state.stats[b.id] || { right: 0, wrong: 0 }
          return (B.wrong - B.right) - (A.wrong - A.right)
        })
      } else {
        list = shuffle([...list])
      }

      state.filtered = list
      state.order = list.map(c => c.id)
      state.i = 0
      state.flipped = false
      state.correct = 0
      state.wrong = 0
    }

    function populateTagFilter () {
      const tags = new Set()
      DECK.forEach(c => (c.tags || []).forEach(t => tags.add(t)))
      for (const t of Array.from(tags).sort()) {
        const opt = document.createElement('option')
        opt.value = t
        opt.textContent = t
        elTagFilter.appendChild(opt)
      }
    }

    function getCardById (id) {
      return DECK.find(c => c.id === id)
    }

    function render () {
      const deck = currentDeck()
      if (!deck.length) {
        elFront.innerHTML = `<h2>No results</h2><div class="subtitle">Adjust filters or search</div>`
        elBack.classList.add('hidden')
        elCount.textContent = '0 / 0'
        elBar.style.width = '0%'
        elScore.textContent = `✅ ${state.correct} • ❌ ${state.wrong}`
        return
      }

      const id = state.order[state.i]
      const c = getCardById(id)

      elFront.innerHTML = `
        <h2>${c.jp}</h2>
        <div class="subtitle">${c.structure}</div>
        <div>${c.meaning}</div>
        <div class="tags">${(c.tags||[]).map(t => `<span class="tag">${t}</span>`).join('')}</div>
      `
      elBack.innerHTML = `
        <h2>${c.jp}</h2>
        <div class="subtitle">${c.structure}</div>
        <div>${c.notes ? `<div style="margin:6px 0 10px;color:#93c5fd">${c.notes}</div>` : ''}</div>
        <div class="examples">
          ${(c.examples || []).map(e => `
            <div class="ex">
              <div class="jp">${e.jp}</div>
              ${e.romaji ? `<div class="romaji">${e.romaji}</div>` : ''}
              <div class="en">${e.en}</div>
            </div>
          `).join('')}
        </div>
      `
      elFront.classList.toggle('hidden', state.flipped)
      elBack.classList.toggle('hidden', !state.flipped)

      elCount.textContent = `${state.i + 1} / ${deck.length}`
      const pct = Math.round(((state.i) / deck.length) * 100)
      elBar.style.width = `${pct}%`

      const s = state.stats[c.id] || { right: 0, wrong: 0 }
      elScore.textContent = `✅ ${state.correct} • ❌ ${state.wrong}  |  Card: ✅ ${s.right} • ❌ ${s.wrong}`
    }

    function flip () {
      state.flipped = !state.flipped
      render()
    }

    function next () {
      if (state.i < state.order.length - 1) {
        state.i++
        state.flipped = false
        render()
      }
    }

    function prev () {
      if (state.i > 0) {
        state.i--
        state.flipped = false
        render()
      }
    }

    function mark (ok) {
      const id = state.order[state.i]
      const s = state.stats[id]
      if (ok) {
        s.right++
        state.correct++
      } else {
        s.wrong++
        state.wrong++
        // simple spaced-practice: reinsert a missed card a few positions ahead
        const insertAt = Math.min(state.order.length, state.i + 3 + Math.floor(Math.random()*2))
        state.order.splice(insertAt, 0, id)
      }
      saveStats()
      next()
    }

    // ---- Events
    elCard.addEventListener('click', flip)
    elFlip.addEventListener('click', flip)
    elPrev.addEventListener('click', prev)
    elAgain.addEventListener('click', () => mark(false))
    elGot.addEventListener('click', () => mark(true))
    elSort.addEventListener('change', () => { applyFilterAndSort(); render() })
    elTagFilter.addEventListener('change', () => { applyFilterAndSort(); render() })
    elSearch.addEventListener('input', () => { applyFilterAndSort(); render() })
    elReset.addEventListener('click', () => {
      if (confirm('Reset all progress?')) {
        localStorage.removeItem(STORAGE_KEY)
        state.stats = loadStats()
        ensureAllStats()
        state.correct = 0
        state.wrong = 0
        applyFilterAndSort()
        render()
      }
    })

    document.addEventListener('keydown', e => {
      if (e.key === ' '){ e.preventDefault(); flip() }
      else if (e.key.toLowerCase() === 'a') mark(false)
      else if (e.key.toLowerCase() === 'g') mark(true)
      else if (e.key === 'ArrowRight') next()
      else if (e.key === 'ArrowLeft') prev()
    })
  </script>
</body>
</html>